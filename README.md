# Delayed Messages
A simple app that lets you write a message with a delay on its reveal.
You can set the length of time before submitting
your message. A countdown is displayed until it's time to show its contents

https://eighty-three.dev/projects/delayed-messages/

## Usage
Write any message (up to 250 characters) in the main field. You can choose how long the delay will take by setting the hours and the minutes. There's a maximum of 23 hours and 59 minutes, and a minimum of 0 hours and 0 minutes which translates to a 10 second delay
![Message](/docs/message.png)

After submitting, it'll redirect you to a unique URL (generated by `shortid`) where it'll show a countdown corresponding to the hours and minutes you set.\
![Countdown](/docs/countdown.gif)


## Technical Documentation
### What's stored
Upon submission of the form, the user sends the following data:
```javascript
        {
          'message': data.content,
          'hours': Number(data.hours),
          'minutes': Number(data.minutes),
        }
```

To be processed by the API
```javascript
  const { hours, minutes, message } = req.body; 
  ...
  const id: string = shortid.generate().substr(0, 10);
  const target: number = 
    Math.floor(Date.now() / 1000) +
    (hours * 3600) + (minutes * 60) + seconds;

  const url = await messages.createMessage(id, message, target);
  res.status(200).json(url.id); //For redirecting
```
The `id`, `message`, and `target` is stored in the following table:

```
CREATE TABLE delayed_messages ( 
  id varchar(10) PRIMARY KEY NOT NULL,
  message varchar(250) NOT NULL,
  target int NOT NULL
);
```

### What's queried
When visiting the url (from the `id`) of the message, it'll first determine if there's a message behind the url:
```javascript
  const message = await messages.getMessage(id);
  if (!message) {
    res.status(404).json({ error: 'Not Found', statusCode: 404 });
    return;
  }
```

Afterwards, it'll get the current time, the target time (from the database), and an arbitrary expiry time, currently set at the day after the target
```javascript
  const current: number = Math.floor(Date.now() / 1000);
  const target: number = message.target;
  const expire: number = target + 86400; //After a day
```

### What's returned
The data the server sends back to the client depends on the values of `current`, `target`, and `expire`
```javascript
  if (current > expire) {
    const deletedMessage = await messages.deleteMessage(id);
    console.dir(`Deleted ${deletedMessage.id} at ${current}`);
    res.status(410).json({ error: 'Deleted URL', statusCode: 410 });

  } else if (current > target) {
    res.json({ 'message': message.message, 'expire': expire });

  } else if (current < target) {
    res.json({ 'target': target });
  }
```

### Countdown
For React to properly reveal the message when the countdown goes to zero, I did the following:
```javascript
  const [ messageContents, setMessageContents ] = useState({target, currentTime, message});
  const timeRemaining = target - currentTime;
  const [ count, setCount ] = useState(timeRemaining);

  const countDown = async () => {
    if (count > 0) {
      setCount(count - 1);
    } else {
      const response = await getMessageData(url);
      const newMessage = {
        message: response.message,
        expire: response.expire
      };

      setMessageContents({...newMessage});
    }
  };
```
I passed both the `count` and `setCount` variables to the `Countdown` component. \
The `Countdown` component uses the following `useEffect` hook to decrease the `count`:
```
  useEffect(() => {
    if (timeRemaining >= 0) timeOut.current = setTimeout(setCounter, 1050);
    return () => clearTimeout(timeOut.current);
  }, [timeRemaining]);
```

When the `count` finally goes to zero (`count > 0` from the `countDown` function), it queries the server to update `messageContents`

### URL deleted from database
As previously shown, if a user visits the URL of a message past its expiry, it'll finally get deleted from the database (I should probably set up a cron job for this too...)
```javascript
  if (current > expire) {
    const deletedMessage = await messages.deleteMessage(id);
    console.dir(`Deleted ${deletedMessage.id} at ${current}`);
    res.status(410).json({ error: 'Deleted URL', statusCode: 410 });
  } ...
```
